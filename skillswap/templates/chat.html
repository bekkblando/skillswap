{% extends 'base.html' %}

{% block body %}
<body>
{% for item in object_list %}
<br/>  <button class="waves-effect cyan darken-4 btn b{{ item.user2.id }}">Show Chat</button>
    <button class="waves-effect cyan darken-4 btn hide{{ item.user2.id }}">Hide Chat</button>
<div class="m{{ item.id }}" style="width:100%;"><h6 class="center-align">{{ item }}</h6></div>
    <form class="f{{ item.id }}">


    <input type="hidden" value="{{ request.user }}" id="user{{ request.user.id }}"/>
    <textarea id="textbox{{ item.id }}">Message Here</textarea>

    {% if request.user == item.user1.user  %}
    <input type="hidden" value="{{ item.user2}}" id="user{{ item.id }}"/>
            <input type="hidden" value="check1" id="check{{ item.id }}"/>
           {% else %}
            <input type="hidden" value="check2" id="check{{ item.id }}"/>

        <input type="hidden" value="{{ item.user1 }}" id="user{{ item.id }}"/>
    {% endif %}
    <input type="hidden" value="{{ item.id }}" id="chat{{ item.id }}"/>
<button class="b1{{ item.user2.id }}" onclick="formread{{ item.id }}()" type="button">Send Message</button>
    </form>



<script type="application/javascript">
    var openchat{{ item.id }} = function (){
        var getUrl = "{% url 'messagelist' item.id %}";
        var messages = [];
        $.getJSON(getUrl, function (data){
            for (var i = 0; i < data.length; i++) {
                var message = (data[i].text);
                messages.push(message);
                console.log("SENDER", data[i].sender);
                if (data[i].sender == 1) {
                    var content = content + "<div class='left'>" + message + "</div><br/>"
                } else {
                    var content = content + "<div class='right'>" + message + "</div><br/>"
                }
            }
            $(".m{{ item.id }}").html(content);
        });
        var poll{{ item.id }} = (function poll() {
                setTimeout(function() {
        openchat{{ item.id }}();
    }, 10000);
    })();
    };
    var hidechat{{ item.id }} = function(){
        var content = " ";
        $(".m{{ item.id }}").html(content);

    };


    $('document').ready(function (){
        $(".b{{ item.user2.id }}").click(openchat{{ item.id }});
        $(".hide{{ item.user2.id }}").click(hidechat{{ item.id }})
    });

    var formread{{ item.id }} = function() {
        var check = document.getElementById("check{{ item.id }}").value;
        if (check == 'check1') {
            var user1 = document.getElementById("user{{ request.user.id }}").value;
            var chat = document.getElementById("chat{{ item.id }}").value;
            var text = document.getElementById("textbox{{ item.id }}").value;

            $.ajax({
              type: 'POST',
              url: {% url 'messagecreate' %},
              data: {user1: user1, chat: chat, text: text},
              beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization','Token {{ token }}' );
              }})
            openchat{{ item.id }}();
        }
        else{
            var user1 = document.getElementById("user{{ request.user.id }}").value;
            var chat = document.getElementById("chat{{ item.id }}").value;
            var text = document.getElementById("textbox{{ item.id }}").value;


            $.ajax({
              type: 'POST',
              url: {% url 'messagecreate' %},
              data: {user1: user1, chat: chat, text: text},
              beforeSend: function(xhr) {
                xhr.setRequestHeader('Authorization','Token {{ token }}' );
              }});
            openchat{{ item.id }}();

};
        }
</script>

{% endfor %}

</body>
{% endblock %}
</html>